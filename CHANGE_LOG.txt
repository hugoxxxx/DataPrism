2026-01-24  修正与改进
- 修正：元数据写入流程进度与完成确认。
	- 在 [src/ui/metadata_editor_dialog.py](src/ui/metadata_editor_dialog.py) 中：确保写入完成时将进度设置为 100、关闭进度对话框；改为弹出模态确认框（用户点击“确定”后关闭编辑器）；增加写入线程结束的后备处理以防止对话框残留。
- 修正：在 [src/core/exif_worker.py](src/core/exif_worker.py) 中修复批量写入的缩进错误并增加超时与日志，确保每个任务实际执行并正确返回结果。
- 改进：调整 [src/ui/main_window.py](src/ui/main_window.py) 的刷新按钮布局和 EXIF 读取/写入进度处理逻辑，增强 UI 反馈。
- 国际化：修复并补充 [src/utils/i18n.py](src/utils/i18n.py) 中的翻译字符串，避免语法错误并添加新提示文本。
- 修复：统一主界面与元数据编辑器的地理位置格式，创建 [src/utils/gps_utils.py](src/utils/gps_utils.py) 集中处理 GPS 解析/格式化逻辑；修复因引号导致的正则解析失败，确保类似 "28deg ... \" N North" 的非标准字符串能被正确格式化为度分秒标准格式；同时增强了 UserComment 中 Location 字段的解析。
- 优化：修改元数据写入完成后的交互逻辑，移除自动关闭编辑器的行为，确保在弹出“写入完成”对话框并等待用户点击确认后，再关闭编辑器窗口，提供更明确的操作反馈。
- 调试：在 [src/core/exif_worker.py](src/core/exif_worker.py) 中增加信号发射的调试输出，用于诊断 result_ready 信号未被接收的问题。
- 修复：在 [src/ui/metadata_editor_dialog.py](src/ui/metadata_editor_dialog.py) 中为所有跨线程信号连接添加 Qt.QueuedConnection，确保信号槽在主 GUI 线程中执行，解决模态对话框导致的线程死锁问题。
- 修复：使用 QTimer.singleShot 延迟弹出完成对话框，避免模态对话框阻塞事件循环导致 finished 信号无法完成的死锁问题。
- 修复：由于 PySide6 的 result_ready 信号无法可靠传递 dict 类型数据，改用在 worker 中存储结果，在 finished 信号处理器中读取的方式，绕过信号系统的限制。
- 修复：完全禁用 result_ready.emit() 调用，因为该调用会阻塞 worker 线程，改为只使用 last_result 实例变量传递数据。
- 修复：移除 finished 信号连接到 quit/deleteLater 的逻辑（会导致死锁），改用 QTimer 每 100ms 轮询线程状态，检测到完成后读取结果并清理资源。
- 修复：完全禁用 finished.emit() 调用（也会阻塞），worker 方法执行完毕后线程自然结束，由 QTimer 检测线程状态变化。

## 2026-01-24 - 鲁棒性改进 / Robustness Improvements

- 新增：统一日志系统 [src/utils/logger.py](src/utils/logger.py)，支持控制台和文件输出，替换所有 print() 调用。
- 新增：全局异常处理器，捕获所有未处理的异常并记录到日志文件，防止程序崩溃。
- 新增：ExifTool 重试机制，最多重试 3 次，使用指数退避策略，提高写入操作的可靠性。
- 新增：资源清理机制，在 MetadataEditorDialog 的 closeEvent 中确保线程和 worker 正确清理，防止内存泄漏。
- 新增：输入验证器 [src/utils/validators.py](src/utils/validators.py)，验证所有元数据字段（光圈、快门、ISO、焦距、日期时间等），防止写入非法数据。
- 新增：配置管理系统 [src/core/config.py](src/core/config.py)，支持 JSON 配置文件持久化，管理 ExifTool 路径、重试次数、UI 设置等。
- 优化：所有调试输出统一使用 logger，支持不同日志级别（DEBUG/INFO/WARNING/ERROR/CRITICAL）。
- 优化：使用信号触发 worker 方法，避免 started 信号的 lambda 阻塞线程事件循环。
- 优化：清理所有调试用的 print() 语句，全部替换为规范的 logger 调用，提升生产环境可用性。
- 修复：胶卷型号写入后不显示的问题，现在同时写入 Film 字段和 UserComment，并在刷新时显示进度对话框。
- 新增：GT23_Workflow 兼容性，ImageDescription 字段优先写入胶卷型号，确保 GT23 自动识别功能正常工作。
- 修复：GPS 坐标写入格式，现在使用与 1.json 一致的 ExifTool 标准格式（如 "28deg 31' 30.59\" N"）。

说明：以上改动为本地调试与用户交互可感知的修复，已在本地测试写入流程并增加调试输出以方便进一步排查。

DataPrism change log
====================

2026-01-23
- Main window columns (v0.3.1): Added Film Stock and Location columns to photo table; inspector now shows film and location; header sizing updated for the two new columns; location now surfaces GPSLatitude/GPSLongitude when present.
- Metadata write enhancement (v0.3.1): Enhanced _build_exif_dict() in metadata_editor_dialog.py with improved field handling: split camera field into Make and Model tags (supports both "Make Model" and single-word formats), added format conversion for aperture (f/2.8→2.8), ISO (ISO 400→400), and focal length (80mm→80); added multi-date field write (DateTimeOriginal, CreateDate, ModifyDate); changed location storage from invalid GPSInfo tag to ImageDescription; enhanced UserComment to combine film stock, location and notes; added notes field to UserComment with proper chaining.
- GPS write support (v0.3.1): Location text now parsed into GPSLatitude/GPSLatitudeRef/GPSLongitude/GPSLongitudeRef when possible while still writing ImageDescription for human-readable location.
- GPS read combining (v0.3.1): Metadata import now merges GPSLatitude/GPSLongitude (+Ref) fields into a single location string for editor display and writing.
- GPS display cleanup (v0.3.1): GPS lat/lon now formatted without duplicated direction words (N/S/E/W) for cleaner Location display.
- Metadata import fix (v0.3.1): Fixed MetadataParser to support ExifTool EXIF tags (Make, Model, FNumber, ExposureTime, ISO, FocalLength, DateTimeOriginal, etc.) in JSON exports; added automatic numeric format conversion (f-stop for FNumber, fraction for ExposureTime, mm for focal length, etc.); extended field mapping across all 10 metadata attributes to handle both Lightme format and ExifTool format simultaneously.
- Editor dialog debugging (v0.3.1): Added logging to metadata_editor_dialog.py load_photo() method for diagnostic support.
- Additional metadata fields (v0.3.1): Added shot_date and location fields to MetadataEntry dataclass; extended field mapping in _parse_entry() for shot_date (DateTimeOriginal, DateTime, CreateDate, ModifyDate, SubSecDateTimeOriginal) and location (GPSLatitude, GPSLongitude, GPSAltitude, GPSLatitudeRef, GPSLongitudeRef, etc.) with support for GPS coordinate tuples and ExifTool native tags; updated MetadataEditorDialog UI with 2 new QLineEdit fields for shot date and location; added translations for "Shot Date:" and "Location:" to i18n.py.
- Write metadata fix (v0.3.1): Fixed on_write_metadata() to correctly map each photo to its corresponding metadata entry with offset consideration; updated _build_exif_dict() to include shot_date and location fields; improved exif_worker.py value validation (check for None and empty string) to ensure all valid metadata is written; added debug logging to track photo-to-metadata mapping during batch write.
- Main window refresh button (v0.3.1): Added "Refresh EXIF" button to main window sidebar for reloading all photos' EXIF data after external modifications; implemented refresh_exif() method that re-reads EXIF asynchronously via queue_exif_read(); button styled with blue gradient matching metadata import button; added translations for "Refresh EXIF" and "No photos to refresh" to i18n.py.
- Cleanup: Removed temporary test scripts, diagnostic documentation files, and all v0.3.1 development draft reports; kept only core implementation and production files.

2026-01-20 (v0.3.1) - Metadata Editor Upgrade
- Universal metadata parser (src/core/metadata_parser.py): created MetadataParser class supporting JSON/CSV/TXT file formats with auto-detection; MetadataEntry dataclass unifies 10 fields (camera, lens, aperture, shutter_speed, iso, film_stock, focal_length, timestamp, frame_number, notes) across all formats.
- JSON parsing (v0.3.1): extended _parse_json() to handle 3 wrapper types (frames, entries, shots); flexible field name mapping with 10+ fallback names per attribute (Camera/camera/Body/body/Model/model etc.); timestamp extraction from ISO 8601 and custom date formats; frame_number inference from entry position or explicit field.
- CSV parsing (v0.3.1): implemented _parse_csv() using DictReader with header-based flexible field mapping; 6+ fallback field names per attribute (e.g., Lens/Lens Model/LensModel/Lens-Model/LensName); handles missing columns gracefully with None defaults.
- TXT parsing (v0.3.1): implemented _parse_txt() with delimiter detection (pipe | or tab); positional field assignment with order: camera, lens, aperture, shutter, iso, film_stock, focal_length, notes; supports variable-length rows.
- New metadata editor dialog (src/ui/metadata_editor_dialog.py): created MetadataEditorDialog as dedicated window for preview/edit/write workflow; 3-section layout with QListWidget for photo navigation, QFormLayout with 8 editable QLineEdit fields, offset spinbox (±20 frames) for sequence adjustment; batch write capability via ExifToolWorker; metadata_written signal triggers main window refresh.
- Offset control (v0.3.1): added QSpinBox in editor dialog for sequence offset adjustment; on_offset_changed() reloads metadata_entries[index + offset] to handle film photography frame skips; range ±20 frames covers typical photoshoot scenarios.
- Count warning (v0.3.1): editor dialog compares metadata record count vs photo count; displays color-coded warning label if mismatch detected; helps users identify incomplete metadata or extra photos.
- Main window integration (v0.3.1): replaced import_json() with import_metadata() supporting all 3 formats; button text changed "Import JSON" → "Import Metadata"; new method opens file dialog (*.json *.csv *.txt), parses via MetadataParser, launches MetadataEditorDialog; new on_metadata_written() callback refreshes EXIF after write.
- Removed old methods (v0.3.1): deleted _apply_json_matches(), _on_batch_write_complete(), _on_batch_write_error() from main_window.py as logic migrated to MetadataEditorDialog.
- Matching strategy update (v0.3.1): changed match_hybrid() default from prefer_timestamp=True to prefer_timestamp=False; sequence-first matching (1:1 in-order) now default for film photography workflows with potential frame skips and multiple dates.
- i18n expansion (v0.3.1): added 20+ new translation strings for metadata editor dialog (Metadata Editor, Edit Metadata, Photos, Camera/Lens/Aperture/Shutter/ISO/Film Stock/Focal Length/Notes labels, Sequence Offset, warning message, Write All Files, Write Metadata, confirmation/success messages) to TranslationManager; full Chinese/English support.
- v0.3.1 complete workflow: Import → Dedicated Editor Window with inline field editing → Sequence offset adjustment → Batch write from dialog → Auto-refresh main window; replaces old preview-only approach with full edit capability in single window.

2026-01-20
- Init log file for PM review.
- UI import: drag-and-drop enabled for image extensions; added Browse files… button that opens a file dialog and reuses drop handler.
- UI list: hooked center view to PhotoDataModel with QTableView; dropped/browsed files are added into the model, placeholder hides when list has data.
- EXIF: MainWindow now wires ExifToolWorker via QThread; new imports trigger queued EXIF reads, results populate PhotoDataModel; worker errors logged; thread stops on window destruction.
- Inspector: right panel now shows selected photo info (file, camera, lens, date, status) with live updates when selection or EXIF results change.
- EXIF decoding: ExifTool worker now decodes stdout/stderr as UTF-8 with errors=replace and guards JSON parse errors to avoid GBK UnicodeDecodeError; timeout bumped to 15s.
- Fonts: removed explicit "System" font to let Qt use default Windows font and silence DirectWrite warnings.
- Inspector thumbnail: added 180x180 preview in inspector; loads QPixmap from file, caches per photo, clears when no selection.
- UI aesthetics (v0.2.0): upgraded table to 52px rows, no grid, macOS colors; status column now shows colored dots (green/blue/red/gray); sidebar buttons have 10px radius with gradients; inspector uses Consolas monospace for data, hierarchical labels, 200px thumbnail with separator; global Big Sur theme (#f5f5f7 background).
- Selection contrast: deepened selection background to #0051d5 with explicit white text for better visibility.
- Metadata expansion (v0.2.1): extended PhotoItem with aperture/shutter/ISO/focal_length/film_stock/serial_number fields; table now 8 columns (File/Camera/Lens/Aperture/Shutter/ISO/Date/Status); formatted display (f/2.8, 1/125s, -- for missing); auto-parse exposure from EXIF; inspector adds Exposure section with bold Consolas font; optimized column widths (fixed for exposure, stretch for file).
- i18n support (v0.2.1): created src/utils/i18n.py translation manager with auto system language detection (Chinese/English); added 中/EN toggle button in sidebar; all UI text (titles/labels/buttons/tooltips/columns) now use tr() function; refresh_ui() method updates entire interface on language switch.
- JSON film log import (v0.3.0): created src/core/json_parser.py with FilmLogParser supporting Lightme/Logbook JSON formats; FilmLogEntry dataclass extracts camera/lens/aperture/shutter/ISO/film_stock/timestamp fields with flexible field name mapping; handles array wrappers (frames/entries/shots) and multiple timestamp formats.
- Photo matching algorithms (v0.3.0): implemented src/core/json_matcher.py with PhotoMatcher class; three strategies: match_by_timestamp (±5min tolerance), match_by_sequence (1:1 order), match_hybrid (timestamp first, fallback to sequence if <50% matched); get_match_statistics returns match rate and counts.
- JSON import UI (v0.3.0): added green gradient "Import JSON" button in sidebar; import_json() method opens file dialog, parses JSON, auto-matches photos, shows preview dialog; integrated with FilmLogParser and PhotoMatcher; checks for imported photos before proceeding.
- Match preview dialog (v0.3.0): created src/ui/match_dialog.py with MatchPreviewDialog showing 6-column table (Photo File/Date → Log Camera/Lens/Date); displays match statistics (matched/total with percentage); time offset adjustment spinbox (±180 minutes) with rematch button; macOS Big Sur styling with rounded corners; confirm/cancel buttons.
- Batch EXIF write (v0.3.0): extended ExifToolWorker.batch_write_exif() for multi-file async writes with progress signals; _apply_json_matches() builds EXIF tasks mapping log entries to Make/Model/LensModel/FNumber/ExposureTime/ISO/FocalLength/DateTimeOriginal/UserComment; QProgressDialog shows write progress; auto-refreshes photo data after completion; error handling with success/failure counts.
- Bug fix (v0.3.0): corrected PhotoMatcher instantiation in main_window.py and match_dialog.py; __init__ only takes time_tolerance_minutes parameter, photos/log_entries passed to match methods; added tuple-to-dict conversion for match results (List[Tuple[PhotoItem, FilmLogEntry]] to Dict[int, int] index mapping) to interface with MatchPreviewDialog.
- Bug fix (v0.3.0): fixed AttributeError in match_dialog.py where PhotoItem.date_taken was accessed but doesn't exist; changed to extract date from exif_data['DateTimeOriginal'] or exif_data['CreateDate']; updated rematch_with_offset to adjust EXIF date strings directly instead of using non-existent date_taken attribute.
- 优化：前台 GPS 显示格式更简洁，去掉秒的小数部分（如 28°31'31"N 而不是 28°31'30.59"N）。
- 新增：CSV/TXT 智能导入功能，支持字段映射对话框、GPS 方向选择、按行序号匹配照片。
- 修复：元数据编辑器数据同步逻辑。实现 `_save_current_metadata` 方法，确保手动修改的 ISO、胶卷、快门等字段在切换照片、调整偏移或写入前能自动保存到内存任务列表中。
- 修复：解决了手动修改元数据后无法写入的问题。
    - 修正了 `MetadataEditorDialog` 中 `notes` 字段访问函数错误（`toPlainText` 改为 `text`）。
    - 统一了 ExifTool 读取与写入的标签命名规则（移除 `-G` 标志），确保写入后的 ISO 等数据能正确回显在主界面。
    - 放宽了胶卷型号识别的关键词限制，支持显示所有手动输入的描述信息。
    - 自动补齐缺失的元数据条目，确保所有照片都能进行手动录入。
- 鲁棒性：增强了元数据写入的兼容性。
    - 验证失败时自动回退到原始输入值，确保非标准数据也可尝试写入。
    - 自动转换日期格式（`-`、`/` 转 `:`）和焦距（移除 `mm`）。
    - 为 ExifTool 添加 UTF-8 字符集支持，解决 Windows 路径和特殊字符编码问题。
- 优化：移除元数据写入完成后多余的“成功读取 EXIF”提示框，减少操作干扰，使流程更顺滑。
