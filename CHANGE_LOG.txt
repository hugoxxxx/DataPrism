DataPrism change log
====================

2026-01-23
- Main window columns (v0.3.1): Added Film Stock and Location columns to photo table; inspector now shows film and location; header sizing updated for the two new columns; location now surfaces GPSLatitude/GPSLongitude when present.
- Metadata write enhancement (v0.3.1): Enhanced _build_exif_dict() in metadata_editor_dialog.py with improved field handling: split camera field into Make and Model tags (supports both "Make Model" and single-word formats), added format conversion for aperture (f/2.8→2.8), ISO (ISO 400→400), and focal length (80mm→80); added multi-date field write (DateTimeOriginal, CreateDate, ModifyDate); changed location storage from invalid GPSInfo tag to ImageDescription; enhanced UserComment to combine film stock, location and notes; added notes field to UserComment with proper chaining.
- GPS write support (v0.3.1): Location text now parsed into GPSLatitude/GPSLatitudeRef/GPSLongitude/GPSLongitudeRef when possible while still writing ImageDescription for human-readable location.
- GPS read combining (v0.3.1): Metadata import now merges GPSLatitude/GPSLongitude (+Ref) fields into a single location string for editor display and writing.
- GPS display cleanup (v0.3.1): GPS lat/lon now formatted without duplicated direction words (N/S/E/W) for cleaner Location display.
- Metadata import fix (v0.3.1): Fixed MetadataParser to support ExifTool EXIF tags (Make, Model, FNumber, ExposureTime, ISO, FocalLength, DateTimeOriginal, etc.) in JSON exports; added automatic numeric format conversion (f-stop for FNumber, fraction for ExposureTime, mm for focal length, etc.); extended field mapping across all 10 metadata attributes to handle both Lightme format and ExifTool format simultaneously.
- Editor dialog debugging (v0.3.1): Added logging to metadata_editor_dialog.py load_photo() method for diagnostic support.
- Additional metadata fields (v0.3.1): Added shot_date and location fields to MetadataEntry dataclass; extended field mapping in _parse_entry() for shot_date (DateTimeOriginal, DateTime, CreateDate, ModifyDate, SubSecDateTimeOriginal) and location (GPSLatitude, GPSLongitude, GPSAltitude, GPSLatitudeRef, GPSLongitudeRef, etc.) with support for GPS coordinate tuples and ExifTool native tags; updated MetadataEditorDialog UI with 2 new QLineEdit fields for shot date and location; added translations for "Shot Date:" and "Location:" to i18n.py.
- Write metadata fix (v0.3.1): Fixed on_write_metadata() to correctly map each photo to its corresponding metadata entry with offset consideration; updated _build_exif_dict() to include shot_date and location fields; improved exif_worker.py value validation (check for None and empty string) to ensure all valid metadata is written; added debug logging to track photo-to-metadata mapping during batch write.
- Main window refresh button (v0.3.1): Added "Refresh EXIF" button to main window sidebar for reloading all photos' EXIF data after external modifications; implemented refresh_exif() method that re-reads EXIF asynchronously via queue_exif_read(); button styled with blue gradient matching metadata import button; added translations for "Refresh EXIF" and "No photos to refresh" to i18n.py.
- Cleanup: Removed temporary test scripts, diagnostic documentation files, and all v0.3.1 development draft reports; kept only core implementation and production files.

2026-01-20 (v0.3.1) - Metadata Editor Upgrade
- Universal metadata parser (src/core/metadata_parser.py): created MetadataParser class supporting JSON/CSV/TXT file formats with auto-detection; MetadataEntry dataclass unifies 10 fields (camera, lens, aperture, shutter_speed, iso, film_stock, focal_length, timestamp, frame_number, notes) across all formats.
- JSON parsing (v0.3.1): extended _parse_json() to handle 3 wrapper types (frames, entries, shots); flexible field name mapping with 10+ fallback names per attribute (Camera/camera/Body/body/Model/model etc.); timestamp extraction from ISO 8601 and custom date formats; frame_number inference from entry position or explicit field.
- CSV parsing (v0.3.1): implemented _parse_csv() using DictReader with header-based flexible field mapping; 6+ fallback field names per attribute (e.g., Lens/Lens Model/LensModel/Lens-Model/LensName); handles missing columns gracefully with None defaults.
- TXT parsing (v0.3.1): implemented _parse_txt() with delimiter detection (pipe | or tab); positional field assignment with order: camera, lens, aperture, shutter, iso, film_stock, focal_length, notes; supports variable-length rows.
- New metadata editor dialog (src/ui/metadata_editor_dialog.py): created MetadataEditorDialog as dedicated window for preview/edit/write workflow; 3-section layout with QListWidget for photo navigation, QFormLayout with 8 editable QLineEdit fields, offset spinbox (±20 frames) for sequence adjustment; batch write capability via ExifToolWorker; metadata_written signal triggers main window refresh.
- Offset control (v0.3.1): added QSpinBox in editor dialog for sequence offset adjustment; on_offset_changed() reloads metadata_entries[index + offset] to handle film photography frame skips; range ±20 frames covers typical photoshoot scenarios.
- Count warning (v0.3.1): editor dialog compares metadata record count vs photo count; displays color-coded warning label if mismatch detected; helps users identify incomplete metadata or extra photos.
- Main window integration (v0.3.1): replaced import_json() with import_metadata() supporting all 3 formats; button text changed "Import JSON" → "Import Metadata"; new method opens file dialog (*.json *.csv *.txt), parses via MetadataParser, launches MetadataEditorDialog; new on_metadata_written() callback refreshes EXIF after write.
- Removed old methods (v0.3.1): deleted _apply_json_matches(), _on_batch_write_complete(), _on_batch_write_error() from main_window.py as logic migrated to MetadataEditorDialog.
- Matching strategy update (v0.3.1): changed match_hybrid() default from prefer_timestamp=True to prefer_timestamp=False; sequence-first matching (1:1 in-order) now default for film photography workflows with potential frame skips and multiple dates.
- i18n expansion (v0.3.1): added 20+ new translation strings for metadata editor dialog (Metadata Editor, Edit Metadata, Photos, Camera/Lens/Aperture/Shutter/ISO/Film Stock/Focal Length/Notes labels, Sequence Offset, warning message, Write All Files, Write Metadata, confirmation/success messages) to TranslationManager; full Chinese/English support.
- v0.3.1 complete workflow: Import → Dedicated Editor Window with inline field editing → Sequence offset adjustment → Batch write from dialog → Auto-refresh main window; replaces old preview-only approach with full edit capability in single window.

2026-01-20
- Init log file for PM review.
- UI import: drag-and-drop enabled for image extensions; added Browse files… button that opens a file dialog and reuses drop handler.
- UI list: hooked center view to PhotoDataModel with QTableView; dropped/browsed files are added into the model, placeholder hides when list has data.
- EXIF: MainWindow now wires ExifToolWorker via QThread; new imports trigger queued EXIF reads, results populate PhotoDataModel; worker errors logged; thread stops on window destruction.
- Inspector: right panel now shows selected photo info (file, camera, lens, date, status) with live updates when selection or EXIF results change.
- EXIF decoding: ExifTool worker now decodes stdout/stderr as UTF-8 with errors=replace and guards JSON parse errors to avoid GBK UnicodeDecodeError; timeout bumped to 15s.
- Fonts: removed explicit "System" font to let Qt use default Windows font and silence DirectWrite warnings.
- Inspector thumbnail: added 180x180 preview in inspector; loads QPixmap from file, caches per photo, clears when no selection.
- UI aesthetics (v0.2.0): upgraded table to 52px rows, no grid, macOS colors; status column now shows colored dots (green/blue/red/gray); sidebar buttons have 10px radius with gradients; inspector uses Consolas monospace for data, hierarchical labels, 200px thumbnail with separator; global Big Sur theme (#f5f5f7 background).
- Selection contrast: deepened selection background to #0051d5 with explicit white text for better visibility.
- Metadata expansion (v0.2.1): extended PhotoItem with aperture/shutter/ISO/focal_length/film_stock/serial_number fields; table now 8 columns (File/Camera/Lens/Aperture/Shutter/ISO/Date/Status); formatted display (f/2.8, 1/125s, -- for missing); auto-parse exposure from EXIF; inspector adds Exposure section with bold Consolas font; optimized column widths (fixed for exposure, stretch for file).
- i18n support (v0.2.1): created src/utils/i18n.py translation manager with auto system language detection (Chinese/English); added 中/EN toggle button in sidebar; all UI text (titles/labels/buttons/tooltips/columns) now use tr() function; refresh_ui() method updates entire interface on language switch.
- JSON film log import (v0.3.0): created src/core/json_parser.py with FilmLogParser supporting Lightme/Logbook JSON formats; FilmLogEntry dataclass extracts camera/lens/aperture/shutter/ISO/film_stock/timestamp fields with flexible field name mapping; handles array wrappers (frames/entries/shots) and multiple timestamp formats.
- Photo matching algorithms (v0.3.0): implemented src/core/json_matcher.py with PhotoMatcher class; three strategies: match_by_timestamp (±5min tolerance), match_by_sequence (1:1 order), match_hybrid (timestamp first, fallback to sequence if <50% matched); get_match_statistics returns match rate and counts.
- JSON import UI (v0.3.0): added green gradient "Import JSON" button in sidebar; import_json() method opens file dialog, parses JSON, auto-matches photos, shows preview dialog; integrated with FilmLogParser and PhotoMatcher; checks for imported photos before proceeding.
- Match preview dialog (v0.3.0): created src/ui/match_dialog.py with MatchPreviewDialog showing 6-column table (Photo File/Date → Log Camera/Lens/Date); displays match statistics (matched/total with percentage); time offset adjustment spinbox (±180 minutes) with rematch button; macOS Big Sur styling with rounded corners; confirm/cancel buttons.
- Batch EXIF write (v0.3.0): extended ExifToolWorker.batch_write_exif() for multi-file async writes with progress signals; _apply_json_matches() builds EXIF tasks mapping log entries to Make/Model/LensModel/FNumber/ExposureTime/ISO/FocalLength/DateTimeOriginal/UserComment; QProgressDialog shows write progress; auto-refreshes photo data after completion; error handling with success/failure counts.
- Bug fix (v0.3.0): corrected PhotoMatcher instantiation in main_window.py and match_dialog.py; __init__ only takes time_tolerance_minutes parameter, photos/log_entries passed to match methods; added tuple-to-dict conversion for match results (List[Tuple[PhotoItem, FilmLogEntry]] to Dict[int, int] index mapping) to interface with MatchPreviewDialog.
- Bug fix (v0.3.0): fixed AttributeError in match_dialog.py where PhotoItem.date_taken was accessed but doesn't exist; changed to extract date from exif_data['DateTimeOriginal'] or exif_data['CreateDate']; updated rematch_with_offset to adjust EXIF date strings directly instead of using non-existent date_taken attribute.
